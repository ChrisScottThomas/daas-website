---
import Base from "../../layouts/base.astro";
import { plans } from "../../data/plans";

const planParam = Astro.params.plan;
const token = Astro.url.searchParams.get("token");

let selectedPlanKey = planParam;
let selectedPlan = null;
let tokenValid = false;

if (!token) {
  throw new Error("Missing token");
}

try {
  const res = await fetch(
    "https://getclarity.win/prod/select-plan?token=" + token,
  );
  if (!res.ok) throw new Error("Token validation failed");
  const data = await res.json();

  if (data.plan !== planParam)
    throw new Error("Token does not match selected plan");
  selectedPlan = plans[data.plan];
  tokenValid = true;
} catch (err) {
  console.error(err);
  throw new Error("Invalid or expired token");
}

if (!selectedPlan) {
  throw new Error("Invalid plan");
}
---

<Base title={`Confirm your plan â€” ${selectedPlan.name}`}>
  <main class="max-w-3xl mx-auto px-4 py-20 text-center">
    <h1 class="text-4xl font-bold mb-4">You've selected:</h1>
    <p class="text-2xl font-semibold mb-8 text-[#429EDB]">
      {selectedPlan.name}
    </p>
    <p class="text-lg text-gray-600 dark:text-gray-300 mb-8">
      {selectedPlan.description}
    </p>

    <div class="flex flex-col gap-6 md:flex-row justify-center items-center">
      <button
        id="cardPaymentBtn"
        class="bg-[#429EDB] hover:bg-[#1F78C1] text-white font-semibold px-6 py-3 rounded-xl transition"
      >
        Pay by Card
      </button>

      <a
        href={`/checkout/invoice/index.html?plan=${selectedPlanKey}`}
        class="bg-[#429EDB] hover:bg-[#1F78C1] text-white font-semibold px-6 py-3 rounded-xl transition"
      >
        Request Invoice
      </a>
    </div>

    <p class="text-sm mt-6 text-gray-400">
      You're not charged until payment is confirmed. Safe, secure and
      regret-free.
    </p>
  </main>

  <script type="module" client:load>
    const plan = "{selectedPlanKey}";
    document
      .getElementById("cardPaymentBtn")
      ?.addEventListener("click", async () => {
        const res = await fetch("API_URL_HERE", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ plan }),
        });
        const data = await res.json();
        if (data.url) {
          window.location.href = data.url;
        } else {
          alert("Something went wrong. Please try again.");
        }
      });
  </script>
</Base>
